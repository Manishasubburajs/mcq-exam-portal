generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model exam_questions {
  exam_question_id Int       @id @default(autoincrement())
  exam_id          Int
  question_id      Int
  question_order   Int
  exams            exams     @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade, onUpdate: NoAction, map: "exam_questions_ibfk_1")
  questions        questions @relation(fields: [question_id], references: [question_id], onDelete: Cascade, onUpdate: NoAction, map: "exam_questions_ibfk_2")

  @@unique([exam_id, question_id], map: "unique_exam_question")
  @@index([exam_id, question_order], map: "idx_exam_order")
  @@index([question_id], map: "question_id")
}

model exams {
  exam_id               Int                     @id @default(autoincrement())
  exam_title            String                  @db.VarChar(255)
  description           String?                 @db.Text
  status                exams_status?           @default(draft)
  subject_id            Int?
  time_limit_minutes    Int?                    @default(30)
  total_marks           Int?                    @default(0)
  question_count        Int?                    @default(0)
  scheduled_start       DateTime?               @db.DateTime(0)
  scheduled_end         DateTime?               @db.DateTime(0)
  is_active             Boolean?                @default(true)
  created_by            Int?
  created_at            DateTime?               @default(now()) @db.Timestamp(0)
  exam_questions        exam_questions[]
  subjects              subjects?               @relation(fields: [subject_id], references: [subject_id], onUpdate: NoAction, map: "exams_ibfk_1")
  users                 users?                  @relation(fields: [created_by], references: [user_id], onUpdate: NoAction, map: "exams_ibfk_2")
  questions             questions[]
  student_exam_attempts student_exam_attempts[]

  @@unique([subject_id, exam_title], map: "uq_subject_title")
  @@index([created_by], map: "created_by")
  @@index([is_active], map: "idx_active")
  @@index([scheduled_start, scheduled_end], map: "idx_scheduled_time")
  @@index([subject_id], map: "subject_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model questions {
  question_id     Int                   @id @default(autoincrement())
  exam_id         Int?
  question_text   String                @db.Text
  option_a        String?               @db.Text
  option_b        String?               @db.Text
  option_c        String?               @db.Text
  option_d        String?               @db.Text
  correct_answer  String?               @db.Text
  points          Int?                  @default(1)
  difficulty      questions_difficulty? @default(Medium)
  subject_id      Int?
  created_by      Int?
  created_at      DateTime?             @default(now()) @db.Timestamp(0)
  updated_at      DateTime?             @default(now()) @db.Timestamp(0)
  is_draft        Boolean?              @default(false)
  exam_questions  exam_questions[]
  subjects        subjects?             @relation(fields: [subject_id], references: [subject_id], onUpdate: NoAction, map: "questions_ibfk_1")
  users           users?                @relation(fields: [created_by], references: [user_id], onUpdate: NoAction, map: "questions_ibfk_2")
  exams           exams?                @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade, onUpdate: NoAction, map: "questions_ibfk_3")
  student_answers student_answers[]

  @@index([created_by], map: "created_by")
  @@index([exam_id], map: "exam_id")
  @@index([difficulty], map: "idx_difficulty")
  @@index([subject_id], map: "idx_subject")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model student_answers {
  answer_id             Int                   @id @default(autoincrement())
  attempt_id            Int
  question_id           Int
  selected_answer       String?               @db.Char(1)
  is_correct            Boolean?              @default(false)
  answered_at           DateTime?             @default(now()) @db.Timestamp(0)
  student_exam_attempts student_exam_attempts @relation(fields: [attempt_id], references: [attempt_id], onDelete: Cascade, onUpdate: NoAction, map: "student_answers_ibfk_1")
  questions             questions             @relation(fields: [question_id], references: [question_id], onDelete: Cascade, onUpdate: NoAction, map: "student_answers_ibfk_2")

  @@unique([attempt_id, question_id], map: "unique_attempt_question")
  @@index([attempt_id], map: "idx_attempt_id")
  @@index([question_id], map: "question_id")
}

model student_details {
  student_id Int                    @id @default(autoincrement())
  user_id    Int                    @unique(map: "user_id_unique")
  dob        DateTime               @db.Date
  gender     student_details_gender
  school     String                 @db.VarChar(100)
  grade      String                 @db.VarChar(20)
  section    String?                @db.VarChar(20)
  users      users                  @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "student_details_ibfk_1")

  @@index([user_id], map: "user_id")
}

model student_exam_attempts {
  attempt_id      Int                           @id @default(autoincrement())
  student_id      Int
  exam_id         Int
  start_time      DateTime                      @db.DateTime(0)
  end_time        DateTime?                     @db.DateTime(0)
  score           Int?                          @default(0)
  total_questions Int
  correct_answers Int?                          @default(0)
  status          student_exam_attempts_status? @default(in_progress)
  student_answers student_answers[]
  users           users                         @relation(fields: [student_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "student_exam_attempts_ibfk_1")
  exams           exams                         @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade, onUpdate: NoAction, map: "student_exam_attempts_ibfk_2")

  @@index([exam_id], map: "exam_id")
  @@index([start_time], map: "idx_start_time")
  @@index([student_id, exam_id], map: "idx_student_exam")
}

model subjects {
  subject_id   Int         @id @default(autoincrement())
  subject_name String      @unique(map: "subject_name") @db.VarChar(100)
  description  String?     @db.Text
  created_by   Int?
  created_at   DateTime?   @default(now()) @db.Timestamp(0)
  exams        exams[]
  questions    questions[]
  users        users?      @relation(fields: [created_by], references: [user_id], onUpdate: NoAction, map: "subjects_ibfk_1")

  @@index([created_by], map: "created_by")
}

model users {
  user_id               Int                     @id @default(autoincrement())
  username              String                  @unique(map: "username") @db.VarChar(50)
  email                 String                  @unique(map: "email") @db.VarChar(100)
  password_hash         String                  @db.VarChar(255)
  role                  users_role
  first_name            String                  @db.VarChar(50)
  last_name             String                  @db.VarChar(50)
  created_at            DateTime?               @default(now()) @db.Timestamp(0)
  last_login            DateTime?               @db.Timestamp(0)
  status                users_status            @default(active)
  department            String?                 @db.VarChar(100)
  exams                 exams[]
  questions             questions[]
  student_details       student_details?
  student_exam_attempts student_exam_attempts[]
  subjects              subjects[]

  @@index([email], map: "idx_email")
  @@index([role], map: "idx_role")
}

enum exams_status {
  draft
  published
}

enum student_details_gender {
  male
  female
  other
}

enum users_role {
  admin
  student
}

enum student_exam_attempts_status {
  in_progress @map("in-progress")
  completed
  expired
}

enum questions_difficulty {
  Easy
  Medium
  Hard
}

enum users_status {
  active
  inactive
  blocked
}
