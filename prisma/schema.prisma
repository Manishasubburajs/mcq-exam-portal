generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model users {
  user_id                Int                        @id @default(autoincrement())
  username               String                     @unique @db.VarChar(50)
  email                  String                     @unique @db.VarChar(100)
  password_hash          String                     @db.VarChar(255)
  role                   users_role
  first_name             String                     @db.VarChar(50)
  last_name              String                     @db.VarChar(50)
  created_at             DateTime                   @default(now())
  status                 users_status               @default(active)
  examAssignmentStudents exam_assignment_students[]
  assignments            exam_assignments[]         @relation("AssignmentsGiven")
  exams_created          exams[]                    @relation("ExamsCreated")
  questions              questions[]
  student_details        student_details?
  attempts               student_exam_attempts[]

  @@index([email])
  @@index([role])
}

model subjects {
  subject_id           Int                    @id @default(autoincrement())
  subject_name         String                 @unique @db.VarChar(100)
  created_at           DateTime               @default(now())
  exam_subject_configs exam_subject_configs[]
  questions            questions[]
  topics               topics[]
}

model topics {
  topic_id             Int                    @id @default(autoincrement())
  subject_id           Int
  topic_name           String                 @db.VarChar(255)
  exam_subject_configs exam_subject_configs[]
  questions            questions[]
  subject              subjects               @relation(fields: [subject_id], references: [subject_id], onDelete: Cascade)

  @@index([subject_id])
}

model exams {
  exam_id                 Int                     @id @default(autoincrement())
  exam_title              String                  @db.VarChar(255)
  description             String?                 @db.Text
  time_limit_minutes      Int                     @default(30)
  total_marks             Decimal                 @default(0) @db.Decimal(12, 4)
  question_count          Int                     @default(0)
  scheduled_start         DateTime?
  scheduled_end           DateTime?
  is_active               Boolean                 @default(true)
  created_by              Int?
  created_at              DateTime                @default(now())
  allow_multiple_attempts Boolean                 @default(true)
  exam_type               exam_type               @default(practice)
  updated_at              DateTime                @updatedAt
  updated_by              Int?
  exam_assignments        exam_assignments[]
  exam_questions          exam_questions[]
  exam_subject_configs    exam_subject_configs[]
  creator                 users?                  @relation("ExamsCreated", fields: [created_by], references: [user_id])
  student_exam_attempts   student_exam_attempts[]

  @@index([created_by])
  @@index([exam_type])
}

model exam_subject_configs {
  id             Int      @id @default(autoincrement())
  exam_id        Int
  subject_id     Int
  topic_id       Int?
  question_count Int
  exam           exams    @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade)
  subject        subjects @relation(fields: [subject_id], references: [subject_id])
  topic          topics?  @relation(fields: [topic_id], references: [topic_id])

  @@index([exam_id])
  @@index([subject_id], map: "exam_subject_configs_subject_id_fkey")
  @@index([topic_id], map: "exam_subject_configs_topic_id_fkey")
}

model exam_questions {
  exam_question_id  Int       @id @default(autoincrement())
  exam_id           Int
  question_id       Int
  question_order    Int
  assigned_marks    Decimal   @db.Decimal(8, 4)
  assigned_negative Decimal   @db.Decimal(8, 4)
  exam              exams     @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade)
  question          questions @relation(fields: [question_id], references: [question_id], onDelete: Cascade)

  @@unique([exam_id, question_id])
  @@index([question_id], map: "exam_questions_question_id_fkey")
}

model questions {
  question_id     Int                  @id @default(autoincrement())
  question_text   String               @db.Text
  option_a        String?              @db.Text
  option_b        String?              @db.Text
  option_c        String?              @db.Text
  option_d        String?              @db.Text
  correct_answer  String?              @db.Char(1)
  marks           Decimal              @default(2) @db.Decimal(8, 4)
  negative_marks  Decimal              @default(0.66) @db.Decimal(8, 4)
  difficulty      questions_difficulty @default(Medium)
  subject_id      Int
  topic_id        Int
  created_by      Int?
  created_at      DateTime             @default(now())
  updated_at      DateTime             @updatedAt
  updated_by      Int?
  exam_questions  exam_questions[]
  creator         users?               @relation(fields: [created_by], references: [user_id])
  subject         subjects             @relation(fields: [subject_id], references: [subject_id])
  topic           topics               @relation(fields: [topic_id], references: [topic_id])
  student_answers student_answers[]

  @@index([subject_id])
  @@index([topic_id])
  @@index([created_by], map: "questions_created_by_fkey")
}

model student_details {
  student_id Int                    @id @default(autoincrement())
  user_id    Int                    @unique
  dob        DateTime               @db.Date
  gender     student_details_gender
  grade      String?                @db.VarChar(50)
  school     String?                @db.VarChar(255)
  section    String?                @db.VarChar(10)
  user       users                  @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model student_exam_attempts {
  attempt_id         Int                          @id @default(autoincrement())
  student_id         Int
  exam_id            Int
  start_time         DateTime
  end_time           DateTime?
  total_time_seconds Int?
  score              Decimal                      @default(0) @db.Decimal(12, 4)
  correct_answers    Int                          @default(0)
  wrong_answers      Int                          @default(0)
  unanswered         Int                          @default(0)
  status             student_exam_attempts_status @default(in_progress)
  student_answers    student_answers[]
  exam               exams                        @relation(fields: [exam_id], references: [exam_id])
  student            users                        @relation(fields: [student_id], references: [user_id])

  @@unique([student_id, exam_id])
  @@index([exam_id], map: "student_exam_attempts_exam_id_fkey")
}

model exam_assignments {
  id          Int                        @id @default(autoincrement())
  exam_id     Int
  assigned_by Int?
  assigned_at DateTime                   @default(now())
  mode        assignment_mode
  students    exam_assignment_students[]
  admin       users?                     @relation("AssignmentsGiven", fields: [assigned_by], references: [user_id])
  exam        exams                      @relation(fields: [exam_id], references: [exam_id], onDelete: Cascade)

  @@index([assigned_by], map: "exam_assignments_assigned_by_fkey")
  @@index([exam_id], map: "exam_assignments_exam_id_fkey")
}

model exam_assignment_students {
  id            Int              @id @default(autoincrement())
  assignment_id Int
  student_id    Int
  assignment    exam_assignments @relation(fields: [assignment_id], references: [id], onDelete: Cascade)
  student       users            @relation(fields: [student_id], references: [user_id])

  @@unique([assignment_id, student_id])
  @@index([student_id], map: "exam_assignment_students_student_id_fkey")
}

model student_answers {
  answer_id          Int                   @id @default(autoincrement())
  attempt_id         Int
  question_id        Int
  selected_answer    String?               @db.Char(1)
  is_correct         Boolean               @default(false)
  time_taken_seconds Int?
  marks_awarded      Decimal               @default(0) @db.Decimal(12, 4)
  attempt            student_exam_attempts @relation(fields: [attempt_id], references: [attempt_id], onDelete: Cascade)
  question           questions             @relation(fields: [question_id], references: [question_id])

  @@unique([attempt_id, question_id])
  @@index([question_id], map: "student_answers_question_id_fkey")
}

enum exam_type {
  practice
  mock
  live
}

enum assignment_mode {
  same
  shuffle
  random
}

enum student_details_gender {
  male
  female
  other
}

enum questions_difficulty {
  Easy
  Medium
  Hard
}

enum users_status {
  active
  inactive
  blocked
}

enum student_exam_attempts_status {
  in_progress
  completed
  expired
}

enum users_role {
  admin
  student
}
